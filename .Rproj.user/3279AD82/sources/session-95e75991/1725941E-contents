# Questão 1 - Lista 2

library(MASS)
library(car)

#Descrição das variáveis:

#y: classificação de qualidade (20 no maximo)
#x1: variedade de vinho (0 — Cabernet Sauvignon, 1 — Shiraz)
#x2: nível de pH
#x3: SO2 total (ppm)
#x4: densidade de cor
#x5: cor de vinho
#x6: cor de pigmento polimérico
#x7: cor de antocianina
#x8: antocianinas totais (g/L)
#x9: grau de ionização das antocianinas (porcentagem)
#x10: antocianinas ionizadas (porcentagem).

#Lendo e fazendo uma primeira observação das variáveis
dados_qualidade_vinho <- read.table("~/UnB/9 semestre/MLG/Listas MLG/dados lista 2/Q01_data.txt", header=T)
head(dados_qualidade_vinho)

# Resumo estatístico dos dados
summary(dados_qualidade_vinho)


#Analisando as possíveis correlações entre as variáveis
##plotando a correlação entre as variáveis
pairs(dados_qualidade_vinho, gap=0.5, pch = 19)

## Matriz de correlação
cor(dados_qualidade_vinho)

###Análise da correlação:
#### x1 tem apenas correlações fracas
#### x2 tem apenas uma correlação negativa moderada com x3
#### x3 tem correlação moderada com todas as variáveis, exceto com x1 
#### x4 tem correlação forte com y, x5, x6, x7, x9, x10
   # além de correlação moderada com x3
#### x5 tem correlação forte com y,x4,x6, x7, x9, x10
   # além de correlação moderada com x3
#### x6 tem correlação forte com y, x4, x5, x7, x10
   # além de correlação moderada com x3, x9
#### x7 tem correlação forte com x4, x5, x6, x9
   # além de correlação moderada com y, x3 
   # além de correlação perfeita com x10
#### x8 tem apenas correlação moderada com x3, x9, x10
#### x9 tem correlação forte com x4, x5, x7, x10
   # além de correlação moderada com y, x3, x6, x8
#### x10 tem correlação forte com x4, x5, x6, x9
   # além de correlação moderada com y, x3, 
   # além de correlação perfeita com x7


# Ajustando o Modelo de Regressão Múltipla
modelo_reg_multi <- lm(y~., data=dados_qualidade_vinho)

summary(modelo_reg_multi)


#Analisando os resíduos do modelo
par(mfrow=c(2,2))
plot(modelo_reg_multi) 
## primeiro gráfico com linha apróx. horizontal - tem linearidade no modelo
## resíduos talvez apróx. com dist. normais no segundo gráfico
## terceiro gráfico observando a homocedasticidade - existe homocedasticidade, pois estão dispersos como retângulo, não triângulo
## quarto gráfico para observar outliers e pontos influentes - resíduos entre -3 e +3 corrteo, além de não aparentar outliers

plot(resid(modelo_reg_multi), ylab="Residuals", xlab="Index")


## Teste de normalidade do resíduos Shapiro-Wilk 
shapiro.test(modelo_reg_multi$residuals) #Não rejeita normalidade dos resíduos (H0)

## Outliers nos resíduos
summary(rstandard(modelo_reg_multi)) #não tem valores fugindo de -3 e +3, então não tem outliers

## Teste de heterocedasticidade breush-pagan para o modelo - só funciona se os resíduos tiverem dist. normal
bptest(modelo_reg_multi) #Não rejeita H0 de que não há heterocedasticidade (há homocedasticidade)
                         # Logo, não há evidências de que há heterocedasticidade

## Teste Durbin-Watson para a presença de autocorrelação nos resíduos (se são indep.) - só funciona se os resíduos tiverem dist. normal 
durbinWatsonTest(modelo_reg_multi) #Não rejeita H0 de que não há autocorrelação
                                   # Logo, os resíduos aparentam ser independentes

## Analisando a ausência de Multicolinearidade no modelo
pairs.panels(dados_qualidade_vinho) #Multicolinearidade se r > 0.9 ou 0.8

# modelo ajustado sem x7 e x10
modelo_reg_multi2 <- lm(y~x1+x2+x3+x4+x6+x8+x9, data=dados_qualidade_vinho)

summary(modelo_reg_multi2)
vif(modelo_reg_multi2) # Multicolinearidade se VIF > 10 (severa) e > 5 (moderada)
                       ## Mostra que mesmo tirando x7 e x10 que tinham correlação perfeita
                       ## Ainda há multicolinearidade em x4, x5, x6 e x9


#modelo_reg_multi2 <- lm(y~ x1 + x2 + x3 + x4 + x8, data=dados_qualidade_vinho)
#summary(modelo_reg_multi2)
#AIC(modelo_reg_multi2)
#vif(modelo_reg_multi2) #testando outros modelos 


## Devido a alta correlação entre diversas variáveis, principalmente x7 com x10,
## o modelo ficou ruim e, além disso, não estimou todos os coeficientes individuais.
## Logo, necessita-se de uma alternativa que retire essa multicolinearidade.



# Letra A - Proponha algum método para resolver o problema da multicolinearidade
# no conjunto de dados.

## Testando método de centrar empiricamente as variáveis com alta multicolinearidade

#dados_qualidade_vinho$x4escalonado <- dados_qualidade_vinho$x4 / sd(dados_qualidade_vinho$x4)
#dados_qualidade_vinho$x5escalonado <- dados_qualidade_vinho$x5 / sd(dados_qualidade_vinho$x5)

#modelo_reg_multi_teste <- lm(y~ x1 + x2 + x3 + x4escalonado +x5escalonado+x6 + x8 +x9, data=dados_qualidade_vinho)
#summary(modelo_reg_multi_teste)
#AIC(modelo_reg_multi_teste)
#vif(modelo_reg_multi_teste) #testando outros modelos

## Para resolver a multicolinearidade, pode-se ser utilizar diversos métodos,
## foi testado Centrar e/ou escalonar e/ou padronizar empiricamente as variáveis, mas pareceu não funcionar ou alterar significativamente a multicolinearidade.
## Com isso, o melhor método pode ser a remoção das variáveis com altos valores de VIF.

# modelo ajustado sem x7 e x10 - as com mais alto nível de correlação
modelo_reg_multi2 <- lm(y~x1+x2+x3+x4+x5+x6+x8+x9, data=dados_qualidade_vinho)

summary(modelo_reg_multi2)
vif(modelo_reg_multi2) 

#modelo ajustado sem as outras variáveis que estão apontando multicolinearidade 
modelo_reg_multi3 <- lm(y~x1+x2+x3+x5+x8, data=dados_qualidade_vinho)

summary(modelo_reg_multi3)
vif(modelo_reg_multi3) #não há mais multicolinearidade



# Letra B - Usando algum método de seleção de variáveis, obtenha o 
# modelo final para o conjunto de dados.

modelo_forward <- stepAIC(modelo_reg_multi3, direction = "forward")

modelo_backward <- stepAIC(modelo_reg_multi2, direction = "backward") 
##seleciona o melhor modelo como y ~ x2 + x5 + x8

modelo_stepwise <- step(modelo_reg_multi2, direction = "both") 
##seleciona o melhor modelo como y ~ x2 + x5 + x8

summary(modelo_stepwise)

modelo_final <- lm(y~ x2 + x5 + x8, data=dados_qualidade_vinho)
summary(modelo_final)

vif(modelo_stepwise) #não há mais multicolinearidade

## Observando pelo método de seleção de variáveis backward e stepwise,
## nota-se que o melhor modelo, com menor AIC (Critério de Informação de Akaike)
## seria um modelo no formato y ~ x1 + x2 + x3 + x9
## Excluindo-se as vaiáveis x4, x5, x6, x7, x8, x10 do modelo.



# Letra C - Apresente a tabela da Análise de Variância para testar a 
# significância global dos coeficientes do modelo final.
# Apresente as hipótese de teste, e conclua.

summary(modelo_final) #apenas a variável x5 é significante

## H0: coeficiente = 0 (não significante)
## H1: coeficiente ≠ 0 (significante)

modelo_final_ajustado <- lm(y~x5, data = dados_qualidade_vinho)
summary(modelo_final_ajustado)


# Letra D - Com base no modelo obtido no item anterior, faça uma 
# análise de resíduos e conclua.



